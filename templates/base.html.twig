<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}CRM{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="csrf-issue-jwt" content="{{ csrf_token('issue_jwt') }}">
    <script src="https://cdn.tailwindcss.com"></script>
  {% if app.user %}
    <script>
      window.APP_USER_ROLES = {{ app.user.roles|json_encode|raw }};
    </script>
  {% else %}
    <script>window.APP_USER_ROLES = [];</script>
  {% endif %}
  {# Bootstrap JWT : d√©finit window.awaitJwt AVANT l'app #}
  <script>
    window.awaitJwt = (async () => {
      try {
        if (localStorage.getItem('jwt_token')) return;
        const meta = document.querySelector('meta[name="csrf-issue-jwt"]');
        if (!meta) return;

        const res = await fetch('/auth/jwt', {
          method: 'POST',
          headers: {
            'X-CSRF-TOKEN': meta.content,
            'X-Requested-With': 'XMLHttpRequest'
          },
          credentials: 'same-origin'
        });

        if (!res.ok) {
          console.warn('/auth/jwt status:', res.status);
          return;
        }
        const data = await res.json();
        if (data?.token) localStorage.setItem('jwt_token', data.token);
      } catch (e) {
        console.warn('JWT bootstrap failed:', e);
      }
    })();
  </script>

  {% block stylesheets %}
    {{ encore_entry_link_tags('app') }}
  {% endblock %}
</head>
<body class="flex">
  <div {{ vue_component('Layout/Sidebar') }}></div>
  <form id="logout-form" action="{{ path('app_logout') }}" method="post" class="hidden">
    <input type="hidden" name="_csrf_token" value="{{ csrf_token('logout') }}">
  </form>

  <main class="flex-1">
    {% block body %}{% endblock %}
  </main>

  {% block javascripts %}
    {{ encore_entry_script_tags('app') }}
  {% endblock %}
</body>
</html>
