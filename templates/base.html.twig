<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}CRM{% endblock %}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  {% if app.user %}
    <script>
      window.APP_USER_ROLES = {{ app.user.roles|json_encode|raw }};
    </script>
{% else %}
    <script>
      window.APP_USER_ROLES = [];
    </script>
{% endif %}
  {{ encore_entry_link_tags('app') }}
  {{ encore_entry_script_tags('app') }}

  <meta name="csrf-issue-jwt" content="{{ csrf_token('issue_jwt') }}">
</head>
<body class="flex">
  <div {{ vue_component('Layout/Sidebar') }}></div>
  <main class="flex-1 p-4">
    {% block body %}{% endblock %}
  </main>
<script type="module">
  // Si l’utilisateur est déjà loggé en session (Twig), on peut demander un JWT
  (async () => {
    try {
      // Évite de regénérer si on a déjà un token (optionnel)
      if (localStorage.getItem('jwt_token')) return;

      const meta = document.querySelector('meta[name="csrf-issue-jwt"]');
      if (!meta) return;

      const res = await fetch('/auth/jwt', {
        method: 'POST',
        headers: {
          'X-CSRF-TOKEN': meta.content,
          'X-Requested-With': 'XMLHttpRequest'
        }
      });
      if (!res.ok) return; // pas bloquant pour l'UI
      const data = await res.json();
      if (data?.token) localStorage.setItem('jwt_token', data.token);
    } catch (e) {
      console.warn('JWT non récupéré:', e);
    }
  })();
</script>
</body>
</html>
